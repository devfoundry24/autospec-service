<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product Attribute Extraction — Demo</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --soft:#1f2937;
      --text:#e5e7eb; --muted:#9ca3af; --brand:#3b82f6; --brand2:#60a5fa;
      --ok:#10b981; --err:#ef4444; --radius:16px;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      --panel-h: 680px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 10% -10%, rgba(59,130,246,.25), transparent 50%),
                  radial-gradient(900px 500px at 110% 10%, rgba(16,185,129,.18), transparent 50%),
                  var(--bg);
      color:var(--text); line-height:1.45;
    }
    .container{ max-width:1200px; margin:48px auto; padding:0 20px; }
    h1{ font-size:28px; margin:0 0 20px }

    .split{ display:grid; grid-template-columns:1fr 1fr; gap:16px; align-items:stretch; }
    @media (max-width: 900px){ .split{ grid-template-columns:1fr } }

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.025), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius); box-shadow: var(--shadow);
      overflow:hidden; display:flex; flex-direction:column; height:var(--panel-h);
    }
    .panel header{
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.07);
      display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0));
    }
    .panel header h3{ margin:0; font-size:16px; font-weight:700; letter-spacing:.2px; }
    .status{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); color:#cbd5e1; }

    .body{ padding:16px; display:flex; gap:12px; flex-direction:column; overflow:auto; }
    label{ font-size:13px; color:#cbd5e1; margin-bottom:4px; display:block }
    input[type="text"], textarea, .file{
      width:100%; background:var(--panel); color:var(--text); border:1px solid rgba(255,255,255,.08);
      border-radius:10px; padding:10px 12px; outline:none;
    }
    textarea{
      resize:vertical; min-height:260px; font: 13.5px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
    }
    .file{ padding:10px 12px }

    .value{
      background:#0b1220; border:1px solid rgba(255,255,255,.08);
      border-radius:10px; padding:10px 12px;
      font: 13.5px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
      white-space:pre-wrap; word-wrap:break-word;
    }
    #attributes{
      min-height: 250px;
      max-height:calc(var(--panel-h) - 340px);
      overflow:auto;
    }
    #fetchBtn{
      min-width:150px;
    }
    .score{
      display:inline-block; padding:8px 12px; border-radius:999px; font-weight:700;
      background:rgba(16,185,129,.15); color:#a7f3d0; border:1px solid rgba(16,185,129,.35);
    }
    .spinner{ width:18px;height:18px;border-radius:50%;
      border:3px solid rgba(255,255,255,.2); border-top-color:#fff; animation:spin .9s linear infinite; display:none; margin-left:6px; }
    .loading .spinner{ display:inline-block } @keyframes spin{ to{ transform:rotate(360deg) } }

    .btn{
      background:linear-gradient(180deg, var(--brand2), var(--brand));
      color:white; border:none; border-radius:12px; padding:12px 16px; cursor:pointer;
      font-weight:700; letter-spacing:.2px; box-shadow:0 10px 22px rgba(59,130,246,.35);
      transition: transform .06s ease, filter .2s ease;
    }
    .btn:active{ transform: translateY(1px) }
    .btn.block{ width:100% }
    .btn.lg{ font-size:16px }
    .btn.ghost{ background:transparent; color:#cbd5e1; border:1px dashed rgba(255,255,255,.25); box-shadow:none; }
    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:nowrap; }
    .actions .inline-input{ flex:1; min-width:200px; }
    .inline-input{ width:260px; }
    .outStatusHidden{ display:none; }
  </style>
</head>
<body>
<div class="container">
  <h1>Product Attribute Extraction — Live Demo</h1>

  <div class="split">
    <!-- LEFT: INPUTS -->
    <section class="panel" id="leftPanel">
      <header>
        <h3>Input • Raw Product</h3>
        <div class="status" id="inStatus">Ready</div>
      </header>
      <div class="body">
        <div>
          <label for="itemId">Feed Item ID</label>
          <input id="itemId" type="text" placeholder="e.g., 1234567890" />
        </div>

        <div>
          <label for="rawInput">Input • Raw Product (JSON or text)</label>
          <textarea id="rawInput" placeholder='{
  "title": "Nike Running Shoes",
  "description": "Men\u2019s road running shoe, red, size 9, breathable mesh"
}'></textarea>
        </div>

        <div>
          <label for="image">Product Image (optional)</label>
          <!-- minimal change: allow multiple -->
          <input id="image" class="file" type="file" accept="image/*" multiple />
        </div>

        <button class="btn lg block" id="runBtn">🚀 Run extraction now</button>
      </div>
    </section>

    <!-- RIGHT: OUTPUTS -->
    <section class="panel" id="rightPanel">
      <header>
        <h3>Output</h3>
      </header>

      <div class="body">
        <div class="actions">
          <input id="itemIdInline" class="inline-input" type="text" placeholder="Enter Feed Item ID" />
          <div class="status outStatusHidden" id="outStatus"><span class="spinner" id="spin"></span></div>
          <button class="btn" id="fetchBtn">Fetch details</button>
        </div>

        <div>
          <label>Product Type</label>
          <div class="value" id="productType">—</div>
        </div>

        <div>
          <label>Status</label>
          <div class="value" id="statusVal">—</div>
        </div>

        <div>
          <label>Extraction Accuracy Score</label>
          <div id="scoreWrap"><span class="score" id="score">—</span></div>
        </div>

        <div>
          <label>Output • Extracted Attributes</label>
          <div class="value" id="attributes">Response will appear here…</div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  const BASE = 'http://localhost:8088/autospec/api/v1/feedItem';

  const itemIdEl = document.getElementById('itemId');
  const itemIdInlineEl = document.getElementById('itemIdInline');
  const rawEl = document.getElementById('rawInput');
  const runBtn = document.getElementById('runBtn');
  const fetchBtn = document.getElementById('fetchBtn');
  const imageEl = document.getElementById('image'); // <-- now supports multiple

  const inStatus = document.getElementById('inStatus');
  const outStatus = document.getElementById('outStatus');

  const productTypeEl = document.getElementById('productType');
  const statusEl = document.getElementById('statusVal');
  const attributesEl = document.getElementById('attributes');
  const scoreEl = document.getElementById('score');

  function toggleLoading(v){
    if(!outStatus) return;
    outStatus.classList.toggle('outStatusHidden', !v);
    outStatus.classList.toggle('loading', v);
  }

  // Read response safely even if server mislabels content-type
  async function readSmart(res){
    const text = await res.text();
    try { return JSON.parse(text); } catch { return text; }
  }

  // Map server response to UI fields
  function updateOutputFromData(data){
    let productType='—', attrs='—', score='—', statusText='—';

    if(typeof data === 'string'){
      attrs = data || '—';
    } else {
      productType = data.productType || data.type || data.category || '—';
      statusText  = data.status || '—';

      const pa = data.productAttributes ?? data.attributes ?? null;
      if (pa) {
        // Build key: value pairs without quotes around keys, each on a new line
        attrs = Object.entries(pa)
          .map(([k,v]) => `${k}: ${JSON.stringify(v)}`)
          .join("\n");
      } else {
        attrs = '—';
      }

      const cs = data.confidenceScore;
      if (typeof cs === 'number') {
        score = `${Math.round(cs * 100)}%`;
      } else {
        const acc = data.accuracy ?? data.confidence ?? data.score;
        score = (typeof acc === 'number') ? `${Math.round(acc*100)}%` : (acc || '—');
      }
    }

    productTypeEl.textContent = productType;
    statusEl.textContent = statusText;
    attributesEl.textContent = attrs;
    scoreEl.textContent = score;
  }

  // (kept for compatibility, not used now)
  function readSelectedImageAsDataURL(){
    const f = imageEl?.files && imageEl.files[0];
    if(!f) return Promise.resolve("");
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result || "");
      reader.onerror = reject;
      reader.readAsDataURL(f);
    });
  }

  // helper: read all selected images as Data URLs (base64)
  async function readSelectedImagesAsDataURLs(){
    const files = imageEl?.files ? Array.from(imageEl.files) : [];
    if (!files.length) return [];
    const readers = files.map(f => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result || "");
      reader.onerror = reject;
      reader.readAsDataURL(f);
    }));
    return Promise.all(readers);
  }

  async function runExtraction(){
    const feedItemId = (itemIdEl.value || '').trim();
    if(!feedItemId){
      alert('Please enter a Feed Item ID.');
      itemIdEl.focus();
      return;
    }

    toggleLoading(true);
    inStatus.textContent = 'Preparing request…';

    try{
      // Read all selected images and send as an array
      const imgDataUrls = await readSelectedImagesAsDataURLs();

      const body = {
        feedItemId: feedItemId,
        productDescription: rawEl.value.trim() || "",
        productImageDataList: imgDataUrls,   // ← array of data URLs
        timeStamp: new Date().toISOString()
      };

      const res = await fetch(`${BASE}/${encodeURIComponent(feedItemId)}`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify(body)
      });

      const data = await readSmart(res);

      if(!res.ok){
        updateOutputFromData('');
        attributesEl.textContent = `❌ API error: ${res.status}\n${typeof data==='string'?data:JSON.stringify(data,null,2)}`;
        return;
      }

      updateOutputFromData(data);
    }catch(err){
      updateOutputFromData('');
      attributesEl.textContent = '❌ ' + (err?.message || String(err));
    }finally{
      toggleLoading(false);
      inStatus.textContent = 'Ready';
    }
  }

  async function fetchByFeedItemId(){
    const id = (itemIdInlineEl.value || '').trim();
    if(!id){ alert('Please enter a Feed Item ID first.'); itemIdInlineEl.focus(); return; }

    toggleLoading(true);

    try{
      const res = await fetch(`${BASE}/${encodeURIComponent(id)}`, {
        method:'GET',
        headers:{ 'Accept':'application/json' }
      });

      const data = await readSmart(res);

      if(!res.ok){
        updateOutputFromData('');
        attributesEl.textContent = `❌ Fetch by ID failed (${res.status}).\n${typeof data==='string'?data:JSON.stringify(data,null,2)}`;
        return;
      }

      updateOutputFromData(data);
    }catch(e){
      updateOutputFromData('');
      attributesEl.textContent = '❌ ' + (e?.message || String(e));
    }finally{
      toggleLoading(false);
    }
  }

  runBtn.addEventListener('click', runExtraction);
  fetchBtn.addEventListener('click', fetchByFeedItemId);

  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ runExtraction(); }
  });
</script>
</body>
</html>
